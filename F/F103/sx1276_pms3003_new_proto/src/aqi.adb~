package body AQI is

   procedure AQI_Task
   is
   begin
      Goal := Clock + Milliseconds (25000);
      loop
         declare
            Idx   : Integer := 1;
            Buff  : UInt8_Array (1 .. 2);
            C     : UInt9;
            for C'Alignment use 1;
            for C'Address use Buff'Address;
         begin
            loop
               if Rx_Ready (USART_1) then
                  Receive (USART_1, C);
                  if Idx = 1 and Buff (1) /= Magic_Num (1) then
                     Idx := 1;
                  elsif Idx = 2 and Buff (1) /= Magic_Num (2) then
                     Idx := 1;
                  else
                     A (Idx) := Buff (1);
                     Idx := Idx + 1;
                     exit when Idx = 25;
                  end if;
               end if;
            end loop;
         end;
         if Check_Valid then
            Turn_Off (Green_LED);
            for J in PM_Select loop
               Swap (Frm.Pm_Ug (J));
            end loop;
            if Compute_Aqi (Frm.Pm_Ug (PM2_5), Slot, AqiVal) then
               declare
                  --               S : String := UInt16'Image (X);
                  Airq : LoRa_Packet;
                  TxBuffer : SPI_Data_8b (1 .. 9);
                  for Airq'Address use TxBuffer'Address;
                  for Airq'Alignment use 1;
               begin
                  Airq.Aqi := UInt16 (AqiVal);
                  Airq.Pm_Ug := Frm.Pm_Ug;
                  Airq.Crc := Update_CRC8 (16#FF#, TxBuffer, 8);
                  if Clock > Goal then
                     SX.Send (TxBuffer, 9);
                     Goal := Clock + Milliseconds (25000);
                  end if;
               end;
            end if;
         else
            Turn_On (Green_LED);
         end if;
      end loop;
   end AQI_Task;

   procedure AQI_Start
   is
   begin
      Set_True (AQI_Go);
   end AQI_Start;
end AQI;
